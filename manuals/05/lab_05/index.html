
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://nus-cs2100de.github.io/labs/manuals/05/lab_05/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Lab 5: Decoding RISC-V Instructions - CS2100DE Labs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M12.3%207.29c.2-.18.44-.29.7-.29.27%200%20.5.11.71.29.19.21.29.45.29.71%200%20.27-.1.5-.29.71-.21.19-.44.29-.71.29-.26%200-.5-.1-.7-.29-.19-.21-.3-.44-.3-.71%200-.26.11-.5.3-.71m-2.5%204.68s2.17-1.72%202.96-1.79c.74-.06.59.79.52%201.23l-.01.06c-.14.53-.31%201.17-.48%201.78-.38%201.39-.75%202.75-.66%203%20.1.34.72-.09%201.17-.39.06-.04.11-.08.16-.11%200%200%20.08-.08.16.03.02.03.04.06.06.08.09.14.14.19.02.27l-.04.02c-.22.15-1.16.81-1.54%201.05-.41.27-1.98%201.17-1.74-.58.21-1.23.49-2.29.71-3.12.41-1.5.59-2.18-.33-1.59-.37.22-.59.36-.72.45-.11.08-.12.08-.19-.05l-.03-.06-.05-.08c-.07-.1-.07-.11.03-.2M22%2012c0%205.5-4.5%2010-10%2010S2%2017.5%202%2012%206.5%202%2012%202s10%204.5%2010%2010m-2%200c0-4.42-3.58-8-8-8s-8%203.58-8%208%203.58%208%208%208%208-3.58%208-8%22/%3E%3C/svg%3E');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Merriweather";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-5-decoding-risc-v-instructions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="CS2100DE Labs" class="md-header__button md-logo" aria-label="CS2100DE Labs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS2100DE Labs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 5: Decoding RISC-V Instructions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_2">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="CS2100DE Labs" class="md-nav__button md-logo" aria-label="CS2100DE Labs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CS2100DE Labs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../howto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to use this website
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../grading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Grading
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Preparing for labs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Preparing for labs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/prerequisites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab Prerequisites
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/nexys4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting to know your Nexys 4
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://nus-cg3207.github.io/labs/getting_started/vivado_install_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation guide for Vivado (from CG3207)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Lab manuals
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Lab manuals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01/lab_01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 1 [Week 3]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02/lab_02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 2 [Week 4]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03/lab_03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 3 [Week 5]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04/lab_04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 4 [Week 6]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-asm-to-0s-and-1s-risc-v-edition" class="md-nav__link">
    <span class="md-ellipsis">
      
        From asm to 0s and 1s - RISC-V edition
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decoding-instructions-in-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decoding instructions in hardware
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decoding instructions in hardware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activity-1-the-immediate-extension-unit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Activity 1: The immediate extension unit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activity-2-the-instruction-decoder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Activity 2: The instruction decoder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activity-3-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Activity 3: Simulation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concluding-remarks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concluding remarks
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<div><h1 id="lab-5-decoding-risc-v-instructions">Lab 5: Decoding RISC-V Instructions</h1>
<p>Welcome back after (hopefully, a relaxing) recess week! Last time, we took a break from hardware design to write some RISC-V assembly code. This week, we will bring hardware back into the picture. We will create a couple of modules that can decode RISC-V machine language instructions, and in particular, extract the immediates and control signals. </p>
<div class="admonition info">
<p class="admonition-title">Project Work</p>
<p>This manual is part of the final project. You do not need to write a report for this. You should work in your project groups. </p>
</div>
<h2 id="introduction">Introduction</h2>
<h3 id="from-asm-to-0s-and-1s-risc-v-edition">From asm to 0s and 1s - RISC-V edition</h3>
<p>We discussed last time that assembly language code maps very closely to machine code. This week, we will explore what exactly that means. </p>
<p>In the first few lab sessions, we designed digital logic and learned how it works. No matter what, digital logic has inputs, and it performs some logical function on these inputs to produce outputs. </p>
<p>A CPU is no different; it too is a logic block. It reads instructions from <em>instruction memory</em>, and performs a series of logical operations on the instruction to "execute" the code. </p>
<p>When a CPU reads instructions, it has no understanding of the English language. Actually, it has no understanding of any programming language either; no, not even assembly language. To a CPU, the instructions are nothing but a series of bits. So, we need to convert our human-readable code to machine code that the CPU can understand.</p>
<p>Every instruction of assembly (pseudoinstructions notwithstanding) gets translated into a series of bits by a piece of software we call the "assembler"; so named because it "assembles" our assembly language code into machine code. This series of bits follows a given format for every different CPU architecture. </p>
<details class="note">
<summary>How is Python/C/Java/JS code run on my CPU?</summary>
<p>The concept of compilation and/or assembly of code in higher-level languages like Python or Java, is a very complex topic, and way out of the scope of this course. If you are interested in these topics, though, you should explore <a href="https://nusmods.com/courses/CS4212/compiler-design">CS4212: Compiler Design</a> and <a href="https://nusmods.com/courses/CS4215/programming-language-implementation">CS4215: Programming Language Implementation</a>. </p>
</details>
<p>For RISC-V, we classify instructions into 6 types, each with their own way of formatting the bits:</p>
<ol>
<li>R-type: Used for data processing instructions where the source and destination operands are all registers. </li>
<li>I-type: Used for data processing instructions where one of the sources is an immediate value, while the rest are registers.</li>
<li>S-type: Used for store instructions, which do not have a destination register.</li>
<li>B-type: Used for branching instructions, which also do not have a destination register. </li>
<li>U-type: Used for the upper-immediate instruction <code>lui</code> and <code>auipc</code>. These have a destination register and a large 20-bit immediate. (In fact, this instruction type allows the largest immediate values, hence why it's so useful). </li>
<li>J-type: Used for <code>jal</code>. Also has a destination register and a large immediate. </li>
</ol>
<p>Each word of machine code has a number of different fields:</p>
<ol>
<li><code>opcode</code>: used by every instruction. This defines what type of instruction we are seeing.</li>
<li><code>funct3</code> and <code>funct7</code>: <code>funct3</code> is used by R-, I-, S-, and B-type instructions. <code>funct7</code> is only used by R-type instructions. These define the specific instruction we want to execute, within the type set by the opcode. </li>
<li><code>rd</code>, <code>rs1</code>, <code>rs2</code>: the destination, source 1 and source 2 registers for the instruction (where applicable). RISC-V has 32 general-purpose registers, labelled <code>x0</code> through <code>x31</code>. Each of rd, rs1 and rs2 are a 5-bit value indexing the register they refer to. E.g. <code>5b10101</code> == 21, so we are talking about <code>x21</code>. </li>
<li><code>imm</code>: used by every instruction type except R. Used to encode the immediate value used, in twos complement signed format. </li>
</ol>
<p>The table provided in the RISC-V Reference Card (available on <a href="https://canvas.nus.edu.sg/courses/69908/files/folder/Lecture%20Notes?preview=6099376">Canvas</a>, or online at https://www.cs.sfu.ca/~ashriram/Courses/CS295/assets/notebooks/RISCV/RISCV_CARD.pdf), shows how the bits are arranged for each type of instruction, as well as the encoding (i.e. what values mean what). </p>
<p>Open up RARS, and then open <code>riscv_asm_sample.asm</code> from last time. Click the "Assemble" button to assemble the file and open the "Execute" tab. It should look like something like this: </p>
<figure>
<p><img alt="" src="../rars_assembled_code.png"></p>
<figcaption>
<p>The assembled code for <code>riscv_asm_sample.asm</code></p>
</figcaption>
</figure>
<p>Notice the "code" column. Consider a simple instruction like <code>add s5, s1, s2</code>. The encoding for this instruction should be:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>opcode</td>
<td>0110011</td>
<td>R-type instruction</td>
</tr>
<tr>
<td>rd</td>
<td>10101</td>
<td>Register <code>x21</code></td>
</tr>
<tr>
<td>funct3</td>
<td>000</td>
<td><code>add</code> instruction</td>
</tr>
<tr>
<td>rs1</td>
<td>01001</td>
<td>Register <code>x9</code></td>
</tr>
<tr>
<td>rs2</td>
<td>10010</td>
<td>Register <code>x18</code></td>
</tr>
<tr>
<td>funct7</td>
<td>0000000</td>
<td><code>add</code> instruction</td>
</tr>
<tr>
<td>imm</td>
<td>N/A</td>
<td>R-type instruction</td>
</tr>
</tbody>
</table>
<p>So, we should get <code>32b00000001 00100100 10001010 10110011</code>, or <code>32h01248AB3</code>. Indeed, cross-checking with RARS, we see that this is correct. </p>
<p>As another example, consider <code>addi s5, s5, -100</code>:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>opcode</td>
<td>0010011</td>
<td>I-type instruction</td>
</tr>
<tr>
<td>rd</td>
<td>10101</td>
<td>Register <code>x21</code></td>
</tr>
<tr>
<td>funct3</td>
<td>000</td>
<td><code>addi</code> instruction</td>
</tr>
<tr>
<td>rs1</td>
<td>10101</td>
<td>Register <code>x21</code></td>
</tr>
<tr>
<td>rs2</td>
<td>N/A</td>
<td>I-type instruction</td>
</tr>
<tr>
<td>funct7</td>
<td>N/A</td>
<td>I-type instruction</td>
</tr>
<tr>
<td>imm</td>
<td>111110011100</td>
<td>12-bit immediate -100</td>
</tr>
</tbody>
</table>
<p>This should be <code>32b1111 1001 1100 1010 1000 1010 1001 0011</code>, or <code>32hf9ca8a93</code>. Once again, this is the same as we find in RARS. </p>
<p>Try to calculate the machine code for the following instructions by hand:</p>
<ol>
<li><code>xori x24, x12, 20</code></li>
<li><code>lw x12, 4(x23)</code></li>
<li><code>sltu x2, x5, x6</code></li>
</ol>
<p>Then, type these instructions in RARS and verify that your calculations are correct. </p>
<h2 id="decoding-instructions-in-hardware">Decoding instructions in hardware</h2>
<p>In this lab, we will attempt to recreate the instruction decoder and the immediate extension modules we saw in the lectures. </p>
<p>Open Vivado and create a new project, using the same settings as we have been using so far. Remember to choose the correct part number, and import the correct constraints file. </p>
<p>Import <a href="https://github.com/NUS-CS2100DE/labs/blob/main/lab_templates/week07/Decoder.sv"><code>Decoder.sv</code></a> and <a href="https://github.com/NUS-CS2100DE/labs/blob/main/lab_templates/week07/Extend.sv"><code>Extend.sv</code></a> from Github, and import them into your project. For now, we won't have a <code>Top</code> module. We'll get to that in a couple of weeks. </p>
<h3 id="activity-1-the-immediate-extension-unit">Activity 1: The immediate extension unit</h3>
<p>Let's start with the simpler of the two files, <code>Extend.sv</code>. Remember how different instruction formats have different ways to encode the immediate values. The Extender module should pick out the right bits, in the right order, from the instruction, and sign-extend them correctly. Remember, all immediates in RISC-V must be sign-extended to maintain their positive/negative sign. </p>
<details class="note">
<summary>What is sign extension?</summary>
<p>Sign-extension allows us to retain the sign of an m-bit binary number when it is extended to an n-bit binary number (n &gt; m). </p>
<p>Consider the 4-bit twos complement number <code>4b1011</code>. This represents -5. If we blindly extend this to 8 bits with 0s in the upper bits, we get <code>8b00001011</code>, which represents 11. </p>
<p>Sign extension solves this problem, by using the MSB to fill the upper bits. That is, if the MSB (sign bit) is 1, the upper bits are all set to 1. If the MSB is 0, the upper bits are all set to 0. So, <code>4b1011</code> would become <code>8b11111011</code>, which is still equal to -5.  </p>
</details>
<p>Remember that there are five kind of instructions in RISC-V that use immediate values. Each of them encode the immediate slightly (or very) differently. </p>
<p>The input <code>instr_imm</code> represents the upper 25 bits of the instruction word. For any instruction, the opcode is stored in the lowest 7 bits, so the immediate is guaranteed to be within these 25 upper bits. </p>
<p>The input <code>imm_src</code> represents the kind of instruction that is being executed. Depending on this, the way the immediate is encoded is different. </p>
<p>The output <code>ext_imm</code> should hold the sign-extended immediate that we calculated. </p>
<h3 id="activity-2-the-instruction-decoder">Activity 2: The instruction decoder</h3>
<p>Now, let's move on to the more complex one, the instruction decoder. </p>
<p>The sole input to this module is the complete instruction to be executed. The outputs are <code>PCS</code>, <code>jump</code>, <code>mem_to_reg</code>, <code>mem_write</code>, <code>alu_control</code>, <code>alu_src_b</code>, <code>imm_src</code> and <code>reg_write</code>. </p>
<p>The purpose of each of these outputs is detailed in Lecture 7's slides. To summarize:</p>
<ol>
<li>
<p><code>PCS</code>: Used to determine the behaviour of the program counter: +4, branch, or jump. </p>
</li>
<li>
<p><code>mem_to_reg</code>: Used to ascertain if the output from the memory should be stored in a register. </p>
</li>
<li>
<p><code>mem_write</code>: Used to determine whether we should read from, or write to, the memory. </p>
</li>
<li>
<p><code>alu_control</code>: Used to determine the operation performed by the ALU.</p>
</li>
<li>
<p><code>alu_src_b</code>: Used to control the second source of the ALU (reg vs imm). </p>
</li>
<li>
<p><code>imm_src</code>: Used to determine the format of the instruction, and therefore, its immediate encoding.</p>
</li>
<li>
<p><code>reg_write</code>: Used to determine whether we should write a value to the register file. </p>
</li>
</ol>
<p>The width of the input and outputs has not been specified in the skeleton file. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You will notice that <code>imm_src</code> goes from the <code>Decoder</code> to the <code>Extend</code> module in the block diagram for a simple single cycle processor in the lecture notes. Indeed, the <code>imm_src</code> in this file will later connect to the <code>imm_src</code> input of the <code>Extend</code> module. So make sure the output of <code>imm_src</code> matches what <code>Extend</code> expects. </p>
</div>
<p>We recommend following these steps to complete the <code>Decoder</code> module:</p>
<ol>
<li>
<p>Complete the <code>assign</code> statements on lines 39-41 so that the logic values <code>opcode</code>, <code>funct3</code> and <code>funct7</code> reflect those components of the instruction. This will make it easier to use these bits later, as they will be used quite a few times. </p>
</li>
<li>
<p>Determine the bit width required for each of the outputs of the decoder, and update the code accordingly. </p>
</li>
<li>
<p>Now, for each of the outputs, write the logic required to set that output. Write the code inside the <code>always @(instr) begin ... end</code> block. This allows us to use constructs like <code>case ... endcase</code> statements in combinational logic. We should also use the ternary operator <code>? :</code> where possible to do so elegantly. </p>
</li>
</ol>
<h3 id="activity-3-simulation">Activity 3: Simulation</h3>
<p>Yes, you know it; it's time for simulation tests. For this time, we will have a skeleton file to use: <a href="https://github.com/NUS-CS2100DE/labs/blob/main/lab_templates/week07/Decoder_Extend_sim.sv"><code>Decoder_Extend_sim.sv</code></a>. Download and import this simulation source into the Vivado project. </p>
<p>Change the widths of the different signals to match those that we used in the <code>Decoder</code> and <code>Extend</code> modules. </p>
<p>Inside the <code>initial begin ... end</code> block, we have included one test case for you: </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">        </span><span class="n">instr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32'hFF8A0A13</span><span class="p">;</span><span class="w"> </span><span class="c1">// corresponds to addi x20, x20, -8</span>
<span class="w">        </span><span class="p">#</span><span class="mi">10</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>This is the machine code for the assembly instruction <code>addi x20, x20, -8</code>. Verify that the outputs of all the signals are as expected. Also, make sure that the immediate output from the <code>Extend</code> module (i.e. <code>ext_imm</code>) is correct. </p>
<p>You should also test plenty of other instructions, to make sure that the decoding works correctly for every type of instruction. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Right click on the <code>ext_imm</code> waveform and set the radix to <code>Signed Decimal</code> for a human-readable interpretation of the decoded immediate. </p>
</div>
<h2 id="concluding-remarks">Concluding remarks</h2>
<div class="admonition success">
<p class="admonition-title">What we should know</p>
<ol>
<li>How assembly language maps to machine language in RISC-V.</li>
<li>The different formats of RISC-V assembly instructions.</li>
<li>How immediates are encoded in different types of instructions. </li>
<li>How to write SystemVerilog code to decode machine language instructions. </li>
</ol>
</div></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"><a property="dct:title" rel="cc:attributionURL" href="https://nus-cs2100de.github.io/labs">NUS CS2100DE Labs</a> by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://github.com/nus-cs2100de">NUS CS2100DE Team</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a>. Template designed by <a href="mailto:neil@neilbaner.net">Neil Banerjee</a>. </p>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/nus-cs2100de" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:neil@nus.edu.sg" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>